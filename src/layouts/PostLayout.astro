---
import "@fontsource-variable/source-serif-4";
import type { CollectionEntry } from "astro:content";
import Tag from "../components/Tag.astro";
import { formatDate, formatDateMachine } from "../utils/format-date";
import BaseLayout from "./BaseLayout.astro";
import { Icon } from "astro-icon/components";

interface Props {
  frontmatter: CollectionEntry<"posts">["data"];
  slug: string;
  readingTime: string;
}

const { frontmatter, slug, readingTime } = Astro.props;

const pixelUrl = `https://analytics.apps.pawcode.de/matomo.php?idsite=9&rec=1&send_image=0&action_name=${encodeURIComponent(
  frontmatter.title,
)}`;
---

<BaseLayout {...frontmatter} slug={`/posts/${slug}`} post={true}>
  <div class="mx-auto max-w-screen-md p-4 @container">
    <section
      class="border-b border-b-neutral-200 pb-2 dark:border-b-neutral-800"
    >
      <div
        class="pb-4 text-neutral-900 @3xl:text-4xl dark:text-neutral-200 flex items-center justify-between"
      >
        <h1
          class="text-3xl font-bold text-neutral-900 @3xl:text-4xl dark:text-neutral-200"
        >
          {frontmatter.title}
        </h1>

        <button
          type="button"
          id="shareButton"
          title="Share post"
          class="inline-flex items-center justify-center cursor-pointer focus:outline-hidden md:text-neutral-600 md:hover:text-neutral-600/75 dark:text-neutral-300 dark:hover:text-neutral-300/75"
        >
          <span class="sr-only">Share post</span>

          <Icon
            id="shareIcon"
            name="heroicons:share"
            class="w-7 h-7 md:w-6 md:h-6"
          />
          <Icon
            id="copyIcon"
            name="heroicons:clipboard-document-check"
            class="w-7 h-7 md:w-6 md:h-6 hidden"
          />
        </button>
      </div>

      <div class="flex flex-wrap items-center gap-1 pb-4">
        {frontmatter.tags?.map((tag) => <Tag label={tag} size="medium" />)}
      </div>

      <p class="text-sm text-right text-neutral-500 dark:text-neutral-300">
        {readingTime}
      </p>
    </section>

    <section
      class="prose prose-neutral prose-code:text-sm prose-lg mt-4 max-w-screen-md dark:prose-invert"
    >
      <div id="content">
        <slot />
      </div>

      <p class="text-sm text-right text-neutral-500 dark:text-neutral-300">
        <time datetime={formatDateMachine(frontmatter.pubDate)}>
          {frontmatter.pubDate && formatDate(frontmatter.pubDate)}
        </time>

        {
          frontmatter.modDate && (
            <time datetime={formatDateMachine(frontmatter.modDate)}>
              {" "}
              (Updated: <span>{formatDate(frontmatter.modDate)}</span>)
            </time>
          )
        }
      </p>

      <hr class="mt-8" />

      <section
        class="prose lg:prose-lg prose-neutral mt-4 max-w-screen-md dark:prose-invert"
      >
        If you have any questions or other feedback, feel free to reach out to
        me on the social media platforms listed below.
      </section>
    </section>
  </div>

  <noscript>
    <img class="opacity-0 w-0 h-0" src={pixelUrl} />
  </noscript>

  <script>
    const shareButton = document.getElementById("shareButton");
    if (shareButton) {
      shareButton.addEventListener("click", async () => {
        const url = window.location.href;
        const title = document.title;

        if (navigator.share) {
          try {
            await navigator.share({ title, url });
            return;
          } catch (err) {
            console.error("Share cancelled or failed:", err);
          }
        }

        try {
          await navigator.clipboard.writeText(url);

          // Show a temporary success icon
          const shareIcon = shareButton.querySelector("#shareIcon");
          shareIcon?.classList.add("hidden");
          const copyIcon = shareButton.querySelector("#copyIcon");
          copyIcon?.classList.remove("hidden");

          setTimeout(() => {
            copyIcon?.classList.add("hidden");
            shareIcon?.classList.remove("hidden");
          }, 3000);
        } catch (err) {
          console.error("Could not copy URL:", err);
          alert("Could not copy URL.");
        }
      });
    }
  </script>
</BaseLayout>
